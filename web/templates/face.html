<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neo Core AI</title>
    <!-- Socket.IO v4 Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern_face.css') }}">
</head>
<body class="idle">

    <div class="interface-container">
        <!-- Abstract Core Representation -->
        <div class="core-wrapper">
            <div class="core-center"></div>
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>
            <div class="ring ring-3"></div>
        </div>

        <div class="status-display" id="status-text">ONLINE</div>
    </div>

    <!-- Hidden connection status indicator for debug, visual is now integrated in design -->
    <div id="conn-status" style="display:none;"></div>

    <script>
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true
        });

        const body = document.body;
        const statusText = document.getElementById('status-text');

        // --- CONNECTION HANDLING ---
        socket.on('connect', () => {
            console.log('✅ Connected to Neo Server');
            statusText.innerText = "ONLINE";
            setState('idle');
        });

        socket.on('disconnect', () => {
            console.warn('❌ Disconnected from Neo Server');
            statusText.innerText = "OFFLINE";
            setState('sleeping');
        });

        // --- STATE HANDLING ---
        socket.on('face_update', (data) => {
            console.log('Core Update:', data);
            
            // Map old face states to new core states if necessary
            // 'user_detected' -> 'idle' (active)
            // 'happy', 'confused' -> 'idle' (or specific core colors if we add them later)
            
            let state = data.state;
            
            // Normalize states
            if (state === 'user_detected' || state === 'happy' || state === 'confused') {
                state = 'idle'; 
            }
            // Ensure alert messages show up
            if (state === 'alert') {
                 statusText.innerText = data.data.msg || "ALERT";
                 // We could add an alert class here
            }

            setState(state, data.data);
        });

        let currentState = 'idle';

        function setState(state, data) {
            currentState = state;
            body.className = state;

            // Updated Status Text Mapping
            const texts = {
                'idle': 'ONLINE',
                'sleeping': 'OFFLINE',
                'listening': 'LISTENING...',
                'thinking': 'PROCESSING...',
                'speaking': 'RESPONDING...',
                'bored': 'STANDBY'
            };

            if (data && data.msg) {
                statusText.innerText = data.msg.toUpperCase();
            } else {
                statusText.innerText = texts[state] || state.toUpperCase();
            }
        }

        // Initialize
        setState('idle');

    </script>
</body>
</html>